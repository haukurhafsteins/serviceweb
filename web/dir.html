<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directory File Viewer and Uploader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #directoryForm,
        #uploadForm {
            margin-bottom: 20px;
        }

        #fileTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #fileTable th,
        #fileTable td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #fileTable th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <h1>Directory File Manager</h1>

    <form id="directoryForm">
        <label for="directory">Directory:</label>
        <input type="text" id="directory" name="directory" required>
        <button type="submit">List Files</button>
    </form>

    <form id="uploadForm" enctype="multipart/form-data">
        <label for="fileUpload">Select file to upload:</label>
        <input type="file" id="fileUpload" name="fileUpload" required>
        <button type="submit">Upload</button>
    </form>

    <button id="deleteButton" onclick="deleteSelectedFiles()">Delete Selected Files</button>

    <table id="fileTable">
        <thead>
            <tr>
                <th>Select</th>
                <th>Path</th>
                <th>Size (bytes)</th>
                <th>Last Modification Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('directoryForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const directory = document.getElementById('directory').value;
            fetch(`/api/list?dir=${directory}`)
                .then(response => response.json())
                .then(data => displayFiles(data))
                .catch(error => console.error('Error fetching files:', error));
        });

        document.getElementById('uploadForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const fileInput = document.getElementById('fileUpload');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            fetch(`/api/upload/${fileInput.files[0].name}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    alert('File uploaded successfully');
                    console.log(data);
                    // Refresh the file list
                    document.getElementById('directoryForm').dispatchEvent(new Event('submit'));
                })
                .catch(error => console.error('Error uploading file:', error));
        });

        function displayFiles(files) {
            const tbody = document.querySelector('#fileTable tbody');
            tbody.innerHTML = '';

            // Check if the response is an error
            if (files.message) {
                const row = document.createElement('tr');
                const errorCell = document.createElement('td');
                errorCell.colSpan = 4;
                errorCell.textContent = files.message;
                row.appendChild(errorCell);
                tbody.appendChild(row);
                return;
            }

            files.forEach(file => {
                const row = document.createElement('tr');

                const selectCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = file.path;
                selectCell.appendChild(checkbox);
                row.appendChild(selectCell);

                const pathCell = document.createElement('td');
                pathCell.textContent = file.path;
                row.appendChild(pathCell);

                const sizeCell = document.createElement('td');
                sizeCell.textContent = file.size;
                row.appendChild(sizeCell);

                const modTimeCell = document.createElement('td');
                const date = new Date(file.modification_time * 1000);
                modTimeCell.textContent = date.toLocaleString();
                row.appendChild(modTimeCell);

                tbody.appendChild(row);
            });
        }

        function deleteSelectedFiles() {
            const selectedFiles = Array.from(document.querySelectorAll('#fileTable tbody input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            if (selectedFiles.length === 0) {
                alert('No files selected for deletion.');
                return;
            }

            fetch('/api/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ files: selectedFiles })
            })
                .then(response => response.json())
                .then(data => {
                    alert('Selected files deleted successfully');
                    console.log(data);
                    // Refresh the file list
                    document.getElementById('directoryForm').dispatchEvent(new Event('submit'));
                })
                .catch(error => console.error('Error deleting files:', error));
        }
    </script>
</body>

</html>