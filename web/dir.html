<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directory File Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #directoryForm,
        #uploadForm {
            margin-bottom: 20px;
        }

        #fileTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #fileTable th,
        #fileTable td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #fileTable th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <h1>Directory File Manager</h1>

    <form id="directoryForm">
        <label for="directory">Directory:</label>
        <input type="text" id="directory" name="directory" required>
        <button type="submit">List Files</button>
    </form>

    <form id="uploadForm" enctype="multipart/form-data">
        <label for="fileUpload">Select files to upload:</label>
        <input type="file" id="fileUpload" name="fileUpload" multiple required>
        <button type="submit">Upload</button>
    </form>

    <div id="prg"></div>

    <button id="deleteButton" onclick="deleteSelectedFiles()">Delete Selected Files</button>
    <button id="downloadButton" onclick="downloadSelectedFiles()">Download Selected Files</button>

    <table id="fileTable">
        <thead>
            <tr>
                <th>Select</th>
                <th>Path</th>
                <th>Size (bytes)</th>
                <th>Last Modification Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('directoryForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const directory = document.getElementById('directory').value;
            fetch(`/api/list?dir=${directory}`)
                .then(response => response.json())
                .then(data => displayFiles(data))
                .catch(error => console.error('Error fetching files:', error));
        });

        document.getElementById('uploadForm').addEventListener('submit', function (evt) {
            evt.preventDefault(); // Prevent normal form submission

            var fileInput = document.querySelector('input[name="fileUpload"]');
            var files = fileInput.files;
            const dir = document.getElementById('directory').value;
            var prg = document.getElementById('prg');

            for (var i = 0; i < files.length; i++) {
                var formData = new FormData();
                formData.append('file', files[i]); // Append the current file

                var url = `/api/upload?dir=${dir}`;

                // Create a progress element for each file
                var progressBar = document.createElement('div');
                var filename = files[i].name;
                progressBar.innerHTML = `<p>${filename}</p><progress value="0" max="100"></progress>`;
                prg.appendChild(progressBar);
                var progressElement = progressBar.querySelector('progress');

                // Use XMLHttpRequest to upload the file and track progress
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);

                xhr.upload.addEventListener('progress', function (event) {
                    if (event.lengthComputable) {
                        var percentComplete = (event.loaded / event.total) * 100;
                        progressElement.value = percentComplete;
                    }
                });

                xhr.addEventListener('load', function () {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        prg.innerHTML += `<p>Upload of ${filename} complete!</p>`;
                        document.getElementById('directoryForm').dispatchEvent(new Event('submit'));
                    } else {
                        prg.innerHTML += `<p>Error uploading ${filename}</p>`;
                    }
                });

                xhr.addEventListener('error', function () {
                    prg.innerHTML += `<p>Error uploading ${filename}</p>`;
                });

                xhr.send(formData);
            }
        });

        function displayFiles(files) {
            const tbody = document.querySelector('#fileTable tbody');
            tbody.innerHTML = '';

            // Check if the response is an error
            if (files.message) {
                const row = document.createElement('tr');
                const errorCell = document.createElement('td');
                errorCell.colSpan = 4;
                errorCell.textContent = files.message;
                row.appendChild(errorCell);
                tbody.appendChild(row);
                return;
            }

            files.forEach(file => {
                const row = document.createElement('tr');

                const selectCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = file.path;
                selectCell.appendChild(checkbox);
                row.appendChild(selectCell);

                const pathCell = document.createElement('td');
                pathCell.textContent = file.path;
                row.appendChild(pathCell);

                const sizeCell = document.createElement('td');
                sizeCell.textContent = file.size;
                row.appendChild(sizeCell);

                const modTimeCell = document.createElement('td');
                const date = new Date(file.modification_time * 1000);
                modTimeCell.textContent = date.toLocaleString();
                row.appendChild(modTimeCell);

                tbody.appendChild(row);
            });
        }

        function deleteSelectedFiles() {
            // Ask the user to confirm deletion
            if (!confirm('Are you sure you want to delete the selected files?')) {
                return;
            }
            const selectedFiles = Array.from(document.querySelectorAll('#fileTable tbody input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            if (selectedFiles.length === 0) {
                alert('No files selected for deletion.');
                return;
            }

            fetch('/api/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ files: selectedFiles })
            })
            .then(response => response.json())
            .then(data => {
                alert('Selected files deleted successfully');
                console.log(data);
                // Refresh the file list
                document.getElementById('directoryForm').dispatchEvent(new Event('submit'));
            })
            .catch(error => console.error('Error deleting files:', error));
        }

        function downloadSelectedFiles() {
            const selectedFiles = Array.from(document.querySelectorAll('#fileTable tbody input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);

            if (selectedFiles.length === 0) {
                alert('No files selected for download.');
                return;
            }

            selectedFiles.forEach(file => {
                const a = document.createElement('a');
                a.href = `/api/download?file=${file}`;
                a.download = file;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }
    </script>
</body>

</html>
